<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- 1. å¼·åˆ¶é–å®šè¢å¹•å¯¬åº¦ï¼Œç¦æ­¢ç¸®æ”¾ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è»Šè¼›ç®¡ç†</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è»Šè¼›ç®¡ç†">
    
    <!-- è¼‰å…¥æ ¸å¿ƒ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin></script>
    
    <style>
        /* 2. ä¿®æ­£ iOS å½ˆæ€§æ²å‹•å°è‡´çš„ç ´ç‰ˆ */
        html, body { 
            height: 100%; 
            width: 100%; 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f1f5f9;
            -webkit-text-size-adjust: 100%; /* ç¦æ­¢æ–‡å­—è‡ªå‹•æ”¾å¤§ */
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* é¿å…è¼¸å…¥æ¡†ç¸®æ”¾ */
        input, select, textarea { font-size: 16px !important; }
        
        /* éŒ¯èª¤è¨Šæ¯æ¡† */
        #error-box { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 20px; }
        
        /* è§£æ±º iOS ç€æµ·é®æ“‹ */
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>

<div id="error-box">
    <h2 class="text-xl font-bold text-red-600">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>
    <div id="error-content" class="mt-4 text-sm font-mono bg-gray-100 p-2 rounded"></div>
</div>

<script>
    window.onerror = function(msg, url, line) {
        document.getElementById('error-box').style.display = 'block';
        document.getElementById('error-content').innerText = msg + "\nLine: " + line;
    };
</script>

<div id="root" class="h-full w-full flex flex-col justify-center items-center text-slate-400">
    <div class="text-5xl mb-4 animate-bounce">ğŸš›</div>
    <div>è¼‰å…¥ä¸­...</div>
</div>

<script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const toROCDate = (dateString) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        return `${date.getFullYear() - 1911}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
    };

    const calculateNextDate = (lastDate, cycle) => {
        if (!lastDate || !cycle) return '';
        const date = new Date(lastDate);
        if (cycle === 'åŠå¹´') date.setMonth(date.getMonth() + 6);
        else date.setFullYear(date.getFullYear() + 1);
        return date.toISOString().split('T')[0];
    };

    const calculateCycle = (vehicleYear) => {
        if (!vehicleYear) return 'ä¸€å¹´';
        return (new Date().getFullYear() - parseInt(vehicleYear)) > 5 ? 'åŠå¹´' : 'ä¸€å¹´';
    };

    const downloadCalendarEvent = (vehicle) => {
        const nextDateStr = vehicle.nextDate.replace(/-/g, '');
        let icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:ã€é©—è»Šã€‘${vehicle.plate}\nDTSTART;VALUE=DATE:${nextDateStr}\nDTEND;VALUE=DATE:${nextDateStr}\nBEGIN:VALARM\nTRIGGER:-P30D\nACTION:DISPLAY\nDESCRIPTION:30å¤©å‰æé†’\nEND:VALARM\nEND:VEVENT\nEND:VCALENDAR`;
        
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(new Blob([icsContent], { type: 'text/calendar;charset=utf-8' }));
        link.setAttribute('download', `${vehicle.plate}.ics`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    const exportToExcel = (vehicles) => {
        if (vehicles.length === 0 || !confirm("ç¢ºå®šåŒ¯å‡ºï¼Ÿ")) return;
        const headers = ["å…¬å¸","è»Šè™Ÿ","å“ç‰Œ","å¹´ä»½","å™¸æ•¸","é€±æœŸ","ä¸Šæ¬¡é©—è»Š","ä¸‹æ¬¡é©—è»Š","ç‹€æ…‹","ä¿éšªæ—¥","ä¿éšªå…¬å¸","è»Šä¸»","å‚™è¨»"];
        const rows = vehicles.map(v => [v.company, v.plate, v.brand, v.year, v.tonnage, v.cycle, toROCDate(v.lastDate), toROCDate(v.nextDate), v.status, toROCDate(v.insuranceDate), v.insurer, v.owner, v.notes]);
        const csvContent = ["\ufeff" + headers.join(",")].concat(rows.map(row => row.map(f => `"${(f||'').toString().replace(/"/g,'""')}"`).join(","))).join("\n");
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
        link.setAttribute('download', `backup_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    const COMPANY_TABS = ["ç¶¿è±(é ­)", "éŠ“è±(é ­)", "ç¶¿è±è²¨é‹(é ­)", "ç¶¿è±(å°¾)", "éŠ“è±(å°¾)", "ç¶¿è±è²¨é‹(å°¾)"];

    function App() {
        const [activeTab, setActiveTab] = useState(COMPANY_TABS[0]);
        const [vehicles, setVehicles] = useState([]);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [editingId, setEditingId] = useState(null);
        const [searchTerm, setSearchTerm] = useState('');
        const [showInstallGuide, setShowInstallGuide] = useState(false);

        const [formData, setFormData] = useState({
            plate: '', brand: '', year: '', tonnage: '', cycle: 'ä¸€å¹´', lastDate: '', status: 'å®Œæˆ', insuranceDate: '', insurer: '', owner: '', notes: ''
        });

        useEffect(() => {
            try {
                const savedData = localStorage.getItem('myVehicleData_iOS_v2');
                if (savedData) setVehicles(JSON.parse(savedData));
            } catch (e) {}
        }, []);

        useEffect(() => {
            if (vehicles.length > 0) localStorage.setItem('myVehicleData_iOS_v2', JSON.stringify(vehicles));
        }, [vehicles]);

        const alerts = useMemo(() => {
            const limit = new Date();
            limit.setDate(limit.getDate() + 30);
            return vehicles.filter(v => new Date(v.nextDate) <= limit || (v.insuranceDate && new Date(v.insuranceDate) <= limit) || v.status === 'å¾…é©—');
        }, [vehicles]);

        const handleSave = (e) => {
            e.preventDefault();
            const nextDate = calculateNextDate(formData.lastDate, formData.cycle);
            const newItem = { ...formData, nextDate, company: activeTab, updatedAt: new Date().toISOString() };
            
            if (editingId) {
                setVehicles(prev => prev.map(v => v.id === editingId ? { ...v, ...newItem, id: v.id } : v));
            } else {
                setVehicles(prev => [...prev, { ...newItem, id: Date.now().toString(), createdAt: new Date().toISOString() }]);
            }
            closeModal();
        };

        const handleDelete = (id) => {
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                const newV = vehicles.filter(v => v.id !== id);
                setVehicles(newV);
                if (newV.length === 0) localStorage.removeItem('myVehicleData_iOS_v2');
            }
        };

        const openModal = (v = null) => {
            if (v) { setFormData({...v}); setEditingId(v.id); }
            else { setFormData({ plate: '', brand: '', year: '', tonnage: '', cycle: 'ä¸€å¹´', lastDate: '', status: 'å®Œæˆ', insuranceDate: '', insurer: '', owner: '', notes: '' }); setEditingId(null); }
            setIsModalOpen(true);
        };

        const closeModal = () => setIsModalOpen(false);

        const sortedVehicles = useMemo(() => {
            return vehicles.filter(v => v.company === activeTab && v.plate.includes(searchTerm.toUpperCase()))
                .sort((a, b) => (a.status === 'å¾…é©—' ? -1 : 1));
        }, [vehicles, activeTab, searchTerm]);

        return (
            <div className="flex flex-col h-full bg-slate-100 safe-area-top safe-area-bottom">
                
                {/* å®‰è£æ•™å­¸ */}
                {showInstallGuide && (
                    <div className="fixed inset-0 z-50 bg-black/80 flex flex-col justify-end p-4 animate-fade-in">
                        <div className="bg-white rounded-xl p-6">
                            <h3 className="font-bold text-lg mb-4">ğŸ“² å®‰è£åˆ°æ¡Œé¢</h3>
                            <p className="mb-2">1. é»æ“Šä¸‹æ–¹ <span className="font-bold text-blue-600">åˆ†äº«æŒ‰éˆ•</span> (æ–¹æ¡†ç®­é ­)</p>
                            <p className="mb-4">2. é¸ <span className="font-bold text-blue-600">åŠ å…¥ä¸»ç•«é¢</span></p>
                            <button onClick={() => setShowInstallGuide(false)} className="w-full bg-slate-200 py-3 rounded-lg font-bold">æˆ‘çŸ¥é“äº†</button>
                        </div>
                    </div>
                )}

                {/* é ‚éƒ¨å°èˆª */}
                <div className="bg-blue-900 text-white p-3 shadow-lg z-10">
                    <div className="flex justify-between items-center mb-3">
                        <div className="flex items-center gap-2">
                            <span className="text-xl">ğŸš›</span>
                            <div>
                                {/* é€™è£¡æ”¹æˆäº†ã€Œè»Šè¼›ç®¡ç†ã€ */}
                                <h1 className="font-bold">è»Šè¼›ç®¡ç†</h1>
                                <div className="text-[10px] opacity-70">iOS ä¿®æ­£ç‰ˆ</div>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowInstallGuide(true)} className="bg-blue-800 px-2 py-1 rounded text-xs">ğŸ“²</button>
                            <button onClick={() => exportToExcel(vehicles)} className="bg-green-600 px-3 py-1 rounded-full text-xs font-bold shadow">åŒ¯å‡º</button>
                            <button onClick={() => openModal()} className="bg-yellow-500 text-blue-900 px-3 py-1 rounded-full font-bold shadow">â•</button>
                        </div>
                    </div>

                    {alerts.length > 0 && (
                        <div className="mb-2 bg-red-600 rounded p-2 flex items-center gap-2 text-xs text-white animate-pulse">
                            <span>âš ï¸</span><span className="font-bold">{alerts.length} å°éœ€è™•ç†ï¼</span>
                        </div>
                    )}

                    <div className="space-y-2">
                        <input type="text" placeholder="ğŸ” æœå°‹è»Šç‰Œ..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value.toUpperCase())}
                            className="w-full bg-blue-800/50 text-white placeholder-blue-300 rounded px-3 py-2 text-sm outline-none" />
                        
                        <div className="flex overflow-x-auto gap-2 hide-scrollbar pb-1">
                            {COMPANY_TABS.map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)}
                                    className={`whitespace-nowrap px-3 py-1.5 rounded text-xs font-bold transition-colors ${
                                        activeTab === tab ? 'bg-white text-blue-900' : 'bg-blue-800/40 text-blue-100'
                                    }`}>
                                    {tab}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>

                {/* ä¸»è¦å…§å®¹ */}
                <div className="flex-1 overflow-y-auto p-3 space-y-3 pb-20">
                    {sortedVehicles.length === 0 ? (
                        <div className="text-center py-10 text-slate-400">
                            <div className="text-4xl mb-2">ğŸš›</div>
                            <p>å°šç„¡è³‡æ–™</p>
                            <p className="text-sm">é»å³ä¸Šè§’ã€Œâ•ã€æ–°å¢</p>
                        </div>
                    ) : (
                        sortedVehicles.map(v => {
                            const isExpire = new Date(v.nextDate) <= new Date(new Date().setDate(new Date().getDate()+30));
                            return (
                                <div key={v.id} className={`bg-white rounded-lg shadow p-3 border-l-4 ${v.status === 'å¾…é©—' ? 'border-red-500' : isExpire ? 'border-orange-400' : 'border-green-500'}`}>
                                    <div className="flex justify-between items-start mb-2 border-b pb-2">
                                        <div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-lg font-bold">{v.plate}</span>
                                                {v.status === 'å¾…é©—' && <span className="bg-red-100 text-red-600 text-[10px] px-1.5 py-0.5 rounded font-bold">å¾…é©—</span>}
                                            </div>
                                            <div className="text-xs text-slate-500">{v.brand} Â· {v.year}å¹´</div>
                                        </div>
                                        <div className="flex gap-3 text-lg">
                                            <button onClick={() => openModal(v)}>âœï¸</button>
                                            <button onClick={() => handleDelete(v.id)}>ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-2 text-sm">
                                        <div className="bg-slate-50 p-2 rounded">
                                            <div className="text-[10px] text-slate-400">ä¸‹æ¬¡é©—è»Š</div>
                                            <div className={`font-bold ${v.status==='å¾…é©—'||isExpire?'text-red-600':''}`}>ğŸ“… {toROCDate(v.nextDate)}</div>
                                        </div>
                                        <div className="bg-slate-50 p-2 rounded">
                                            <div className="text-[10px] text-slate-400">ä¿éšªåˆ°æœŸ</div>
                                            <div className="font-medium">{toROCDate(v.insuranceDate) || 'æœªå¡«'}</div>
                                        </div>
                                    </div>
                                    {v.notes && <div className="mt-2 text-xs bg-yellow-50 p-1.5 rounded text-yellow-800">ğŸ“ {v.notes}</div>}
                                    <button onClick={() => downloadCalendarEvent(v)} className="w-full mt-2 border border-blue-200 text-blue-600 py-1.5 rounded text-xs font-bold">ğŸ”” åŠ å…¥è¡Œäº‹æ›†</button>
                                </div>
                            )
                        })
                    )}
                </div>

                {/* æ–°å¢/ç·¨è¼¯è¦–çª— */}
                {isModalOpen && (
                    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                        <div className="bg-white w-full max-w-md rounded-xl p-4 shadow-2xl max-h-[90vh] overflow-y-auto">
                            <div className="flex justify-between items-center mb-4 border-b pb-2">
                                <h3 className="font-bold text-lg">{editingId ? 'ç·¨è¼¯' : 'æ–°å¢'}</h3>
                                <button onClick={closeModal} className="text-xl">âœ–ï¸</button>
                            </div>
                            <form onSubmit={handleSave} className="space-y-3">
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs font-bold">è»Šè™Ÿ *</label><input required className="w-full border rounded p-2 uppercase" value={formData.plate} onChange={e=>setFormData({...formData, plate: e.target.value.toUpperCase()})} /></div>
                                    <div><label className="text-xs font-bold">å“ç‰Œ</label><input className="w-full border rounded p-2" value={formData.brand} onChange={e=>setFormData({...formData, brand: e.target.value})} /></div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs font-bold">å¹´ä»½(è¥¿å…ƒ)*</label><input required type="number" className="w-full border rounded p-2" value={formData.year} onChange={e=>{
                                        const y=e.target.value;
                                        setFormData({...formData, year:y, cycle: (new Date().getFullYear()-y)>5?'åŠå¹´':'ä¸€å¹´'})
                                    }} /></div>
                                    <div><label className="text-xs font-bold">é€±æœŸ</label><input disabled className="w-full bg-slate-100 border rounded p-2 text-slate-500" value={formData.cycle} /></div>
                                </div>
                                <div className="bg-slate-50 p-3 rounded">
                                    <label className="text-xs font-bold">ä¸Šæ¬¡é©—è»Š *</label>
                                    <input required type="date" className="w-full border rounded p-2 mb-2" value={formData.lastDate} onChange={e=>setFormData({...formData, lastDate: e.target.value})} />
                                    <div className="flex gap-2">
                                        {['å®Œæˆ','å¾…é©—'].map(s=>(<button type="button" key={s} onClick={()=>setFormData({...formData, status:s})} className={`flex-1 py-1.5 rounded text-xs font-bold ${formData.status===s?(s==='å®Œæˆ'?'bg-green-500 text-white':'bg-red-500 text-white'):'bg-white border'}`}>{s}</button>))}
                                    </div>
                                </div>
                                <div className="bg-green-50 p-3 rounded border border-green-100">
                                    <div className="mb-2"><label className="text-xs font-bold text-green-800">ä¿éšªåˆ°æœŸ</label><input type="date" className="w-full border rounded p-2" value={formData.insuranceDate} onChange={e=>setFormData({...formData, insuranceDate: e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-green-800">ä¿éšªå…¬å¸</label><input className="w-full border rounded p-2" value={formData.insurer} onChange={e=>setFormData({...formData, insurer: e.target.value})} /></div>
                                </div>
                                <div><label className="text-xs font-bold">å‚™è¨»</label><textarea className="w-full border rounded p-2" rows="2" value={formData.notes} onChange={e=>setFormData({...formData, notes: e.target.value})}></textarea></div>
                                <button className="w-full bg-blue-900 text-white py-3 rounded-lg font-bold">å„²å­˜</button>
                            </form>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
