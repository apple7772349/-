<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è»Šè¼›ç®¡ç†</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è»Šè¼›ç®¡ç†">
    
    <!-- è¼‰å…¥æ ¸å¿ƒ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin></script>
    
    <style>
        html, body { 
            height: 100%; 
            width: 100%; 
            max-width: 100vw; 
            overflow-x: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f1f5f9;
            -webkit-text-size-adjust: 100%;
            touch-action: pan-y; 
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        input, select, textarea { font-size: 16px !important; }
        
        #error-box { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 20px; }
        
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>

<div id="error-box">
    <h2 class="text-xl font-bold text-red-600">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>
    <div id="error-content" class="mt-4 text-sm font-mono bg-gray-100 p-2 rounded"></div>
</div>

<script>
    window.onerror = function(msg, url, line) {
        document.getElementById('error-box').style.display = 'block';
        document.getElementById('error-content').innerText = msg + "\nLine: " + line;
    };
</script>

<div id="root" class="h-full w-full flex flex-col justify-center items-center text-slate-400">
    <div class="text-5xl mb-4 animate-bounce">ğŸš›</div>
    <div>ç³»çµ±è¼‰å…¥ä¸­...</div>
</div>

<script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    const toROCDate = (dateString) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        return `${date.getFullYear() - 1911}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
    };

    const calculateNextDate = (lastDate, cycle) => {
        if (!lastDate || !cycle) return '';
        const date = new Date(lastDate);
        if (cycle === 'åŠå¹´') date.setMonth(date.getMonth() + 6);
        else date.setFullYear(date.getFullYear() + 1);
        return date.toISOString().split('T')[0];
    };

    const calculateCycle = (vehicleYear) => {
        if (!vehicleYear) return 'ä¸€å¹´';
        return (new Date().getFullYear() - parseInt(vehicleYear)) > 5 ? 'åŠå¹´' : 'ä¸€å¹´';
    };

    const downloadCalendarEvent = (vehicle) => {
        const nextDateStr = vehicle.nextDate.replace(/-/g, '');
        let icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:ã€é©—è»Šã€‘${vehicle.plate}\nDTSTART;VALUE=DATE:${nextDateStr}\nDTEND;VALUE=DATE:${nextDateStr}\nBEGIN:VALARM\nTRIGGER:-P30D\nACTION:DISPLAY\nDESCRIPTION:30å¤©å‰æé†’\nEND:VALARM\nEND:VEVENT\nEND:VCALENDAR`;
        
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(new Blob([icsContent], { type: 'text/calendar;charset=utf-8' }));
        link.setAttribute('download', `${vehicle.plate}.ics`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    // åŒ¯å‡º Excel (çµ¦äººçœ‹çš„)
    const exportToExcel = (vehicles) => {
        if (vehicles.length === 0 || !confirm("ç¢ºå®šåŒ¯å‡ºå ±è¡¨ï¼Ÿ")) return;
        const headers = ["å…¬å¸","è»Šè™Ÿ","å“ç‰Œ","å¹´ä»½","å™¸æ•¸","é€±æœŸ","ä¸Šæ¬¡é©—è»Š","ä¸‹æ¬¡é©—è»Š","ç‹€æ…‹","ä¿éšªæ—¥","ä¿éšªå…¬å¸","è»Šä¸»","å‚™è¨»"];
        const rows = vehicles.map(v => [v.company, v.plate, v.brand, v.year, v.tonnage, v.cycle, toROCDate(v.lastDate), toROCDate(v.nextDate), v.status, toROCDate(v.insuranceDate), v.insurer, v.owner, v.notes]);
        const csvContent = ["\ufeff" + headers.join(",")].concat(rows.map(row => row.map(f => `"${(f||'').toString().replace(/"/g,'""')}"`).join(","))).join("\n");
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
        link.setAttribute('download', `è»Šè¼›å ±è¡¨_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    // åŒ¯å‡º JSON (çµ¦ç³»çµ±åŒæ­¥ç”¨çš„)
    const exportSyncData = (vehicles) => {
        if (vehicles.length === 0) return alert("æ²’æœ‰è³‡æ–™å¯å‚³é€");
        const jsonContent = JSON.stringify(vehicles);
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(new Blob([jsonContent], { type: 'application/json' }));
        link.setAttribute('download', `è»Šè¼›åŒæ­¥æª”_${new Date().toISOString().split('T')[0]}.json`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert("åŒæ­¥æª”å·²ä¸‹è¼‰ï¼\nè«‹ç”¨ Line å‚³çµ¦è€é—†ï¼Œè€é—†å†æŒ‰ã€ŒåŒ¯å…¥ã€å³å¯ã€‚");
    };

    const COMPANY_TABS = ["ç¶¿è±(é ­)", "éŠ“è±(é ­)", "ç¶¿è±è²¨é‹(é ­)", "ç¶¿è±(å°¾)", "éŠ“è±(å°¾)", "ç¶¿è±è²¨é‹(å°¾)"];

    function App() {
        const [activeTab, setActiveTab] = useState(COMPANY_TABS[0]);
        const [vehicles, setVehicles] = useState([]);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [editingId, setEditingId] = useState(null);
        const [searchTerm, setSearchTerm] = useState('');
        const [showInstallGuide, setShowInstallGuide] = useState(false);
        const fileInputRef = useRef(null);

        const [formData, setFormData] = useState({
            plate: '', brand: '', year: '', tonnage: '', cycle: 'ä¸€å¹´', lastDate: '', status: 'å®Œæˆ', insuranceDate: '', insurer: '', owner: '', notes: ''
        });

        useEffect(() => {
            try {
                const savedData = localStorage.getItem('myVehicleData_iOS_v2');
                if (savedData) setVehicles(JSON.parse(savedData));
            } catch (e) {}
        }, []);

        useEffect(() => {
            if (vehicles.length > 0) localStorage.setItem('myVehicleData_iOS_v2', JSON.stringify(vehicles));
        }, [vehicles]);

        // åŒ¯å…¥åŠŸèƒ½ (åŒæ­¥æ ¸å¿ƒ)
        const handleImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) throw new Error("æ ¼å¼éŒ¯èª¤");

                    // åˆä½µé‚è¼¯ï¼šä»¥è»Šè™Ÿ (plate) ç‚ºæº–ã€‚å¦‚æœè»Šè™Ÿä¸€æ¨£ï¼Œæ›´æ–°è³‡æ–™ï¼›å¦‚æœæ²’é€™è»Šè™Ÿï¼Œæ–°å¢ã€‚
                    const currentVehicles = [...vehicles];
                    let addedCount = 0;
                    let updatedCount = 0;

                    importedData.forEach(newV => {
                        const index = currentVehicles.findIndex(v => v.plate === newV.plate);
                        if (index !== -1) {
                            // æ›´æ–°èˆŠè³‡æ–™
                            currentVehicles[index] = { ...newV, id: currentVehicles[index].id }; 
                            updatedCount++;
                        } else {
                            // æ–°å¢è³‡æ–™ (çµ¦ä¸€å€‹æ–°ID)
                            currentVehicles.push({ ...newV, id: Date.now().toString() + Math.random() });
                            addedCount++;
                        }
                    });

                    setVehicles(currentVehicles);
                    alert(`åŒæ­¥æˆåŠŸï¼\næ–°å¢: ${addedCount} ç­†\næ›´æ–°: ${updatedCount} ç­†`);
                } catch (error) {
                    alert("åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦ç‚ºã€Œè»Šè¼›åŒæ­¥æª”.jsonã€");
                }
                event.target.value = null; // é‡ç½®
            };
            reader.readAsText(file);
        };

        const alerts = useMemo(() => {
            const limit = new Date();
            limit.setDate(limit.getDate() + 30);
            return vehicles.filter(v => new Date(v.nextDate) <= limit || (v.insuranceDate && new Date(v.insuranceDate) <= limit) || v.status === 'å¾…é©—');
        }, [vehicles]);

        const handleSave = (e) => {
            e.preventDefault();
            const nextDate = calculateNextDate(formData.lastDate, formData.cycle);
            const newItem = { ...formData, nextDate, company: activeTab, updatedAt: new Date().toISOString() };
            
            if (editingId) {
                setVehicles(prev => prev.map(v => v.id === editingId ? { ...v, ...newItem, id: v.id } : v));
            } else {
                setVehicles(prev => [...prev, { ...newItem, id: Date.now().toString(), createdAt: new Date().toISOString() }]);
            }
            closeModal();
        };

        const handleDelete = (id) => {
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                const newV = vehicles.filter(v => v.id !== id);
                setVehicles(newV);
                if (newV.length === 0) localStorage.removeItem('myVehicleData_iOS_v2');
            }
        };

        const openModal = (v = null) => {
            if (v) { setFormData({...v}); setEditingId(v.id); }
            else { setFormData({ plate: '', brand: '', year: '', tonnage: '', cycle: 'ä¸€å¹´', lastDate: '', status: 'å®Œæˆ', insuranceDate: '', insurer: '', owner: '', notes: '' }); setEditingId(null); }
            setIsModalOpen(true);
        };

        const closeModal = () => setIsModalOpen(false);

        const sortedVehicles = useMemo(() => {
            return vehicles.filter(v => v.company === activeTab && v.plate.includes(searchTerm.toUpperCase()))
                .sort((a, b) => (a.status === 'å¾…é©—' ? -1 : 1));
        }, [vehicles, activeTab, searchTerm]);

        return (
            <div className="flex flex-col h-full bg-slate-100 safe-area-top safe-area-bottom w-full max-w-full overflow-hidden">
                
                {/* éš±è—çš„æª”æ¡ˆè¼¸å…¥æ¡† */}
                <input type="file" ref={fileInputRef} onChange={handleImport} accept=".json" style={{display:'none'}} />

                {showInstallGuide && (
                    <div className="fixed inset-0 z-50 bg-black/80 flex flex-col justify-end p-4 animate-fade-in">
                        <div className="bg-white rounded-xl p-6">
                            <h3 className="font-bold text-lg mb-4">ğŸ“² å®‰è£åˆ°æ¡Œé¢</h3>
                            <p className="mb-2">1. é»æ“Šä¸‹æ–¹ <span className="font-bold text-blue-600">åˆ†äº«æŒ‰éˆ•</span></p>
                            <p className="mb-4">2. é¸ <span className="font-bold text-blue-600">åŠ å…¥ä¸»ç•«é¢</span></p>
                            <button onClick={() => setShowInstallGuide(false)} className="w-full bg-slate-200 py-3 rounded-lg font-bold">æˆ‘çŸ¥é“äº†</button>
                        </div>
                    </div>
                )}

                {/* é ‚éƒ¨å°èˆª */}
                <div className="bg-blue-900 text-white p-3 shadow-lg z-10 w-full">
                    <div className="flex justify-between items-center mb-2">
                        <div className="flex items-center gap-1 shrink-0">
                            <span className="text-xl">ğŸš›</span>
                            <h1 className="font-bold text-lg">è»Šè¼›ç®¡ç†</h1>
                        </div>
                        <div className="flex gap-2 shrink-0">
                            {/* åŒæ­¥æŒ‰éˆ•å€ */}
                            <button onClick={() => exportSyncData(vehicles)} className="bg-purple-600 px-2 py-1.5 rounded text-xs font-bold shadow">
                                ğŸ“¤ å‚³é€
                            </button>
                            <button onClick={() => fileInputRef.current.click()} className="bg-blue-500 px-2 py-1.5 rounded text-xs font-bold shadow">
                                ğŸ“¥ åŒ¯å…¥
                            </button>
                            <button onClick={() => exportToExcel(vehicles)} className="bg-green-600 px-2 py-1.5 rounded text-xs font-bold shadow">
                                å ±è¡¨
                            </button>
                            <button onClick={() => openModal()} className="bg-yellow-500 text-blue-900 px-2 py-1.5 rounded font-bold shadow text-xs">
                                â•
                            </button>
                        </div>
                    </div>

                    {alerts.length > 0 && (
                        <div className="mb-2 bg-red-600 rounded p-1.5 flex items-center gap-2 text-xs text-white animate-pulse">
                            <span>âš ï¸</span><span className="font-bold">{alerts.length} å°éœ€è™•ç†</span>
                        </div>
                    )}

                    <div className="space-y-2 w-full">
                        <input type="text" placeholder="ğŸ” æœå°‹è»Šç‰Œ..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value.toUpperCase())}
                            className="w-full bg-blue-800/50 text-white placeholder-blue-300 rounded px-3 py-2 text-sm outline-none" />
                        
                        <div className="flex overflow-x-auto gap-2 hide-scrollbar pb-1 w-full">
                            {COMPANY_TABS.map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)}
                                    className={`whitespace-nowrap px-3 py-1.5 rounded text-xs font-bold transition-colors flex-shrink-0 ${
                                        activeTab === tab ? 'bg-white text-blue-900' : 'bg-blue-800/40 text-blue-100'
                                    }`}>
                                    {tab}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>

                {/* ä¸»è¦å…§å®¹ */}
                <div className="flex-1 overflow-y-auto p-3 space-y-3 pb-20 w-full">
                    {sortedVehicles.length === 0 ? (
                        <div className="text-center py-10 text-slate-400">
                            <div className="text-4xl mb-2">ğŸš›</div>
                            <p>å°šç„¡è³‡æ–™</p>
                            <p className="text-sm">å¯æŒ‰ã€ŒğŸ“¥ åŒ¯å…¥ã€æ¥æ”¶å“¡å·¥è³‡æ–™</p>
                        </div>
                    ) : (
                        sortedVehicles.map(v => {
                            const isExpire = new Date(v.nextDate) <= new Date(new Date().setDate(new Date().getDate()+30));
                            return (
                                <div key={v.id} className={`bg-white rounded-lg shadow p-3 border-l-4 ${v.status === 'å¾…é©—' ? 'border-red-500' : isExpire ? 'border-orange-400' : 'border-green-500'}`}>
                                    <div className="flex justify-between items-start mb-2 border-b pb-2">
                                        <div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-xl font-bold text-slate-800">{v.plate}</span>
                                                {v.status === 'å¾…é©—' && <span className="bg-red-100 text-red-600 text-[10px] px-1.5 py-0.5 rounded font-bold">å¾…é©—</span>}
                                            </div>
                                            <div className="text-xs text-slate-500 mt-1 flex flex-wrap gap-x-2">
                                                <span>{v.brand}</span>
                                                <span className="text-slate-300">|</span>
                                                <span>{v.year}å¹´({v.cycle})</span>
                                                <span className="text-slate-300">|</span>
                                                <span>{v.tonnage ? v.tonnage+'å™¸' : '-å™¸'}</span>
                                            </div>
                                            <div className="text-sm font-bold text-blue-800 mt-1">
                                                ğŸ‘¤ {v.owner || 'æœªå¡«è»Šä¸»'}
                                            </div>
                                        </div>
                                        <div className="flex gap-3 text-lg">
                                            <button onClick={() => openModal(v)}>âœï¸</button>
                                            <button onClick={() => handleDelete(v.id)}>ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-2 text-sm mt-2">
                                        <div className="bg-slate-50 p-2 rounded border border-slate-100">
                                            <div className="text-[10px] text-slate-400 flex justify-between">
                                                <span>ä¸‹æ¬¡é©—è»Š</span>
                                                <span className="text-[9px]">{toROCDate(v.lastDate)}</span>
                                            </div>
                                            <div className={`font-bold text-base ${v.status==='å¾…é©—'||isExpire?'text-red-600':''}`}>
                                                ğŸ“… {toROCDate(v.nextDate)}
                                            </div>
                                        </div>
                                        <div className="bg-green-50 p-2 rounded border border-green-100">
                                            <div className="text-[10px] text-green-700 flex justify-between">
                                                <span>ä¿éšªåˆ°æœŸ</span>
                                                <span className="text-[9px]">{v.insurer}</span>
                                            </div>
                                            <div className="font-bold text-base text-slate-700">
                                                ğŸ›¡ï¸ {toROCDate(v.insuranceDate) || '--'}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {v.notes && <div className="mt-2 text-xs bg-yellow-50 p-2 rounded text-yellow-800 border border-yellow-100">ğŸ“ {v.notes}</div>}
                                    
                                    <button onClick={() => downloadCalendarEvent(v)} className="w-full mt-2 border border-blue-200 text-blue-600 py-1.5 rounded text-xs font-bold bg-blue-50">
                                        ğŸ”” åŠ å…¥è¡Œäº‹æ›†
                                    </button>
                                </div>
                            )
                        })
                    )}
                </div>

                {/* æ–°å¢/ç·¨è¼¯è¦–çª— (å…§å®¹ä¿æŒä¸è®Š) */}
                {isModalOpen && (
                    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                        <div className="bg-white w-full max-w-md rounded-xl p-4 shadow-2xl max-h-[90vh] overflow-y-auto">
                            <div className="flex justify-between items-center mb-4 border-b pb-2">
                                <h3 className="font-bold text-lg">{editingId ? 'ç·¨è¼¯' : 'æ–°å¢'}</h3>
                                <button onClick={closeModal} className="text-xl">âœ–ï¸</button>
                            </div>
                            <form onSubmit={handleSave} className="space-y-3">
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs font-bold text-slate-500">è»Šè™Ÿ *</label><input required className="w-full border rounded p-2 uppercase font-bold" value={formData.plate} onChange={e=>setFormData({...formData, plate: e.target.value.toUpperCase()})} /></div>
                                    <div><label className="text-xs font-bold text-slate-500">å“ç‰Œ</label><input className="w-full border rounded p-2" value={formData.brand} onChange={e=>setFormData({...formData, brand: e.target.value})} /></div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs font-bold text-slate-500">å¹´ä»½(è¥¿å…ƒ)*</label><input required type="number" className="w-full border rounded p-2" value={formData.year} onChange={e=>{
                                        const y=e.target.value;
                                        setFormData({...formData, year:y, cycle: (new Date().getFullYear()-y)>5?'åŠå¹´':'ä¸€å¹´'})
                                    }} /></div>
                                    <div><label className="text-xs font-bold text-slate-500">å™¸æ•¸</label><input type="number" className="w-full border rounded p-2" value={formData.tonnage} onChange={e=>setFormData({...formData, tonnage: e.target.value})} /></div>
                                </div>
                                <div><label className="text-xs font-bold text-slate-500">è»Šä¸»å§“å</label><input className="w-full border rounded p-2" placeholder="è¼¸å…¥è»Šä¸»å§“å" value={formData.owner} onChange={e=>setFormData({...formData, owner: e.target.value})} /></div>
                                <div className="bg-slate-50 p-3 rounded border border-slate-200">
                                    <div className="flex justify-between mb-1">
                                        <label className="text-xs font-bold text-slate-500">ä¸Šæ¬¡é©—è»Šæ—¥ *</label>
                                        <span className="text-[10px] text-blue-500">é€±æœŸ: {formData.cycle}</span>
                                    </div>
                                    <input required type="date" className="w-full border rounded p-2 mb-2" value={formData.lastDate} onChange={e=>setFormData({...formData, lastDate: e.target.value})} />
                                    <div className="flex gap-2">
                                        {['å®Œæˆ','å¾…é©—'].map(s=>(<button type="button" key={s} onClick={()=>setFormData({...formData, status:s})} className={`flex-1 py-1.5 rounded text-xs font-bold ${formData.status===s?(s==='å®Œæˆ'?'bg-green-500 text-white':'bg-red-500 text-white'):'bg-white border text-slate-500'}`}>{s}</button>))}
                                    </div>
                                </div>
                                <div className="bg-green-50 p-3 rounded border border-green-100">
                                    <div className="grid grid-cols-2 gap-3 mb-2">
                                        <div><label className="text-xs font-bold text-green-800">ä¿éšªåˆ°æœŸ</label><input type="date" className="w-full border rounded p-2" value={formData.insuranceDate} onChange={e=>setFormData({...formData, insuranceDate: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-green-800">ä¿éšªå…¬å¸</label><input className="w-full border rounded p-2" value={formData.insurer} onChange={e=>setFormData({...formData, insurer: e.target.value})} /></div>
                                    </div>
                                </div>
                                <div><label className="text-xs font-bold text-slate-500">å‚™è¨»</label><textarea className="w-full border rounded p-2" rows="2" value={formData.notes} onChange={e=>setFormData({...formData, notes: e.target.value})}></textarea></div>
                                <button className="w-full bg-blue-900 text-white py-3 rounded-lg font-bold text-lg shadow-md">å„²å­˜è³‡æ–™</button>
                            </form>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
