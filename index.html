<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è»Šè¼›ç®¡ç†</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è»Šè¼›ç®¡ç†">
    
    <!-- è¼‰å…¥æ ¸å¿ƒ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin></script>
    
    <style>
        html, body { 
            height: 100%; 
            width: 100%; 
            max-width: 100vw; 
            overflow-x: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f1f5f9;
            -webkit-text-size-adjust: 100%;
            touch-action: pan-y; 
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        input, select, textarea { font-size: 16px !important; }
        
        #error-box { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 20px; }
        
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>

<div id="error-box">
    <h2 class="text-xl font-bold text-red-600">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>
    <div id="error-content" class="mt-4 text-sm font-mono bg-gray-100 p-2 rounded"></div>
</div>

<script>
    window.onerror = function(msg, url, line) {
        document.getElementById('error-box').style.display = 'block';
        document.getElementById('error-content').innerText = msg + "\nLine: " + line;
    };
</script>

<div id="root" class="h-full w-full flex flex-col justify-center items-center text-slate-400">
    <div class="text-5xl mb-4 animate-bounce">ğŸš›</div>
    <div>ç³»çµ±è¼‰å…¥ä¸­...</div>
</div>

<script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    const toROCDate = (dateString) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        return `${date.getFullYear() - 1911}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
    };

    const calculateNextDate = (lastDate, cycle) => {
        if (!lastDate || !cycle) return '';
        const date = new Date(lastDate);
        if (cycle === 'åŠå¹´') date.setMonth(date.getMonth() + 6);
        else date.setFullYear(date.getFullYear() + 1);
        return date.toISOString().split('T')[0];
    };

    // --- æ ¸å¿ƒä¿®æ”¹ï¼šé©—è»Šé€±æœŸåˆ¤æ–· ---
    const calculateCycle = (vehicleYear, company) => {
        // å¦‚æœæ˜¯å°¾è»Šï¼Œå›ºå®šä¸€å¹´é©—
        if (company && company.includes('(å°¾)')) {
            return 'ä¸€å¹´';
        }
        
        // å¦‚æœæ˜¯é ­è»Šï¼Œä¾ç…§å¹´ä»½åˆ¤æ–·
        if (!vehicleYear) return 'ä¸€å¹´';
        const currentYear = new Date().getFullYear();
        const vYear = parseInt(vehicleYear);
        return (currentYear - vYear) > 5 ? 'åŠå¹´' : 'ä¸€å¹´';
    };

    const downloadCalendarEvent = (vehicle) => {
        const nextDateStr = vehicle.nextDate.replace(/-/g, '');
        let icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:ã€é©—è»Šã€‘${vehicle.plate}\nDTSTART;VALUE=DATE:${nextDateStr}\nDTEND;VALUE=DATE:${nextDateStr}\nBEGIN:VALARM\nTRIGGER:-P30D\nACTION:DISPLAY\nDESCRIPTION:30å¤©å‰æé†’\nEND:VALARM\nEND:VEVENT\nEND:VCALENDAR`;
        
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(new Blob([icsContent], { type: 'text/calendar;charset=utf-8' }));
        link.setAttribute('download', `${vehicle.plate}.ics`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    // åŒ¯å‡º Excel
    const exportToExcel = (vehicles) => {
        if (vehicles.length === 0 || !confirm("ç¢ºå®šåŒ¯å‡ºå ±è¡¨ï¼Ÿ")) return;
        
        // å°‡ã€Œä¿éšªå…¬å¸ã€æ¬„ä½åç¨±æ”¹ç‚ºã€Œä¿éšª/è»Šå°¾å‹å¼ã€ä»¥å…±ç”¨
        const headers = ["å…¬å¸","è»Šè™Ÿ","å“ç‰Œ","å¹´ä»½","å™¸æ•¸/è¦æ ¼","ä¸Šæ¬¡é©—è»Šæ—¥","ä¿éšªåˆ°æœŸæ—¥","ä¿éšª/è»Šå°¾å‹å¼","è»Šä¸»","å‚™è¨»"];
        
        const rows = vehicles.map(v => {
            const isTrailer = v.company && v.company.includes('(å°¾)');
            // å¦‚æœæ˜¯å°¾è»Šï¼Œç”¨ trailerType å–ä»£ insurer
            const insuranceOrType = isTrailer ? (v.trailerType || '') : (v.insurer || '');
            
            return [
                v.company, 
                v.plate, 
                v.brand, 
                v.year, 
                v.tonnage, 
                toROCDate(v.lastDate), 
                toROCDate(v.insuranceDate), 
                insuranceOrType, 
                v.owner, 
                v.notes
            ];
        });
        
        const csvContent = ["\ufeff" + headers.join(",")].concat(rows.map(row => row.map(f => `"${(f||'').toString().replace(/"/g,'""')}"`).join(","))).join("\n");
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
        link.setAttribute('download', `è»Šè¼›å ±è¡¨_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    const exportSyncData = (vehicles) => {
        if (vehicles.length === 0) return alert("æ²’æœ‰è³‡æ–™å¯å‚³é€");
        const jsonContent = JSON.stringify(vehicles);
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(new Blob([jsonContent], { type: 'application/json' }));
        link.setAttribute('download', `è»Šè¼›åŒæ­¥æª”_${new Date().toISOString().split('T')[0]}.json`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert("åŒæ­¥æª”å·²ä¸‹è¼‰ï¼è«‹å‚³çµ¦è€é—†åŒ¯å…¥ã€‚");
    };

    const COMPANY_LIST = ["ç¶¿è±(é ­)", "éŠ“è±(é ­)", "ç¶¿è±è²¨é‹(é ­)", "ç¶¿è±(å°¾)", "éŠ“è±(å°¾)", "ç¶¿è±è²¨é‹(å°¾)"];
    const SPECIAL_STATUS_LIST = ["åœé§›", "æ‰£ç‰Œ", "å ±å»¢", "éæˆ¶"];
    const SPECIAL_STATUS_OPTIONS = ["ç„¡", ...SPECIAL_STATUS_LIST];

    function App() {
        const [activeTab, setActiveTab] = useState(COMPANY_LIST[0]);
        const [vehicles, setVehicles] = useState([]);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [editingId, setEditingId] = useState(null);
        const [searchTerm, setSearchTerm] = useState('');
        const [showInstallGuide, setShowInstallGuide] = useState(false);
        const fileInputRef = useRef(null);
        const passFileInputRef = useRef(null); 

        const [formData, setFormData] = useState({
            company: COMPANY_LIST[0], 
            plate: '', brand: '', year: '', tonnage: '', cycle: 'ä¸€å¹´', lastDate: '', status: 'å®Œæˆ', 
            insuranceDate: '', insurer: '', 
            trailerType: '',
            passName: '', passDate: '', passFile: '', passFileName: '', owner: '', notes: '',
            specialStatus: 'ç„¡', specialDateStart: '', specialDateEnd: ''
        });

        useEffect(() => {
            try {
                const savedData = localStorage.getItem('myVehicleData_iOS_v2');
                if (savedData) setVehicles(JSON.parse(savedData));
            } catch (e) {}
        }, []);

        useEffect(() => {
            if (vehicles.length > 0) {
                try {
                    localStorage.setItem('myVehicleData_iOS_v2', JSON.stringify(vehicles));
                } catch (e) {
                    alert("å„²å­˜å¤±æ•—ï¼šæ‰‹æ©Ÿå®¹é‡å·²æ»¿ï¼\nè«‹åˆªé™¤ä¸€äº›é€šè¡Œè­‰æª”æ¡ˆæˆ–èˆŠè³‡æ–™ã€‚");
                }
            }
        }, [vehicles]);

        const handleRenewInsurance = (id, currentDate) => {
            if (!currentDate) return alert("ç›®å‰æ²’æœ‰ä¿éšªæ—¥æœŸï¼Œè«‹å…ˆé»æ“Šç·¨è¼¯è¨­å®šã€‚");
            if (confirm(`ç¢ºå®šè¦å°‡é€™å°è»Šçš„ä¿éšªã€Œè‡ªå‹•çºŒä¿ä¸€å¹´ã€å—ï¼Ÿ\n\nåŸåˆ°æœŸæ—¥ï¼š${toROCDate(currentDate)}`)) {
                const date = new Date(currentDate);
                date.setFullYear(date.getFullYear() + 1);
                const newDateStr = date.toISOString().split('T')[0];
                setVehicles(prev => prev.map(v => v.id === id ? { ...v, insuranceDate: newDateStr, updatedAt: new Date().toISOString() } : v));
            }
        };

        const handleImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) throw new Error("æ ¼å¼éŒ¯èª¤");
                    const currentVehicles = [...vehicles];
                    let addedCount = 0;
                    let updatedCount = 0;
                    importedData.forEach(newV => {
                        const index = currentVehicles.findIndex(v => v.plate === newV.plate);
                        if (index !== -1) {
                            currentVehicles[index] = { ...newV, id: currentVehicles[index].id }; 
                            updatedCount++;
                        } else {
                            currentVehicles.push({ ...newV, id: Date.now().toString() + Math.random() });
                            addedCount++;
                        }
                    });
                    setVehicles(currentVehicles);
                    alert(`åŒæ­¥æˆåŠŸï¼\næ–°å¢: ${addedCount} ç­†\næ›´æ–°: ${updatedCount} ç­†`);
                } catch (error) {
                    alert("åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ­£ç¢º");
                }
                event.target.value = null;
            };
            reader.readAsText(file);
        };

        const handlePassFileChange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 500 * 1024) {
                alert("æª”æ¡ˆå¤ªå¤§äº†ï¼(è¶…é 500KB)\nç‚ºäº†é¿å…æ‰‹æ©Ÿå®¹é‡çˆ†ç‚¸ï¼Œè«‹ä¸Šå‚³è¼ƒå°çš„ PDF æˆ–æˆªåœ–ã€‚");
                event.target.value = null;
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                setFormData({
                    ...formData,
                    passFile: e.target.result,
                    passFileName: file.name
                });
            };
            reader.readAsDataURL(file);
        };

        const clearPassFile = () => {
            setFormData({ ...formData, passFile: '', passFileName: '' });
            if(passFileInputRef.current) passFileInputRef.current.value = '';
        };

        const alerts = useMemo(() => {
            const limit = new Date();
            limit.setDate(limit.getDate() + 30);
            return vehicles.filter(v => {
                if (v.specialStatus !== 'ç„¡' && v.specialStatus) return false;
                const insDue = v.insuranceDate && new Date(v.insuranceDate) <= limit;
                const passDue = v.passDate && new Date(v.passDate) <= limit;
                return new Date(v.nextDate) <= limit || insDue || passDue || v.status === 'å¾…é©—';
            });
        }, [vehicles]);

        const handleSave = (e) => {
            e.preventDefault();
            const nextDate = calculateNextDate(formData.lastDate, formData.cycle);
            
            let saveCompany = formData.company;
            if (!saveCompany && COMPANY_LIST.includes(activeTab)) {
                saveCompany = activeTab;
            } else if (!saveCompany) {
                saveCompany = COMPANY_LIST[0];
            }

            const newItem = { ...formData, nextDate, company: saveCompany, updatedAt: new Date().toISOString() };
            
            if (editingId) {
                setVehicles(prev => prev.map(v => v.id === editingId ? { ...v, ...newItem, id: v.id } : v));
            } else {
                setVehicles(prev => [...prev, { ...newItem, id: Date.now().toString(), createdAt: new Date().toISOString() }]);
            }
            
            if (newItem.specialStatus !== 'ç„¡') {
                setActiveTab(newItem.specialStatus);
            } else {
                setActiveTab(newItem.company);
            }

            closeModal();
        };

        const handleDelete = (id) => {
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                const newV = vehicles.filter(v => v.id !== id);
                setVehicles(newV);
                if (newV.length === 0) localStorage.removeItem('myVehicleData_iOS_v2');
            }
        };

        const openModal = (v = null) => {
            if (v) { 
                setFormData({...v}); 
                setEditingId(v.id); 
            } else { 
                const defaultCompany = COMPANY_LIST.includes(activeTab) ? activeTab : COMPANY_LIST[0];
                const defaultCycle = defaultCompany.includes('(å°¾)') ? 'ä¸€å¹´' : 'ä¸€å¹´';
                
                setFormData({ 
                    company: defaultCompany,
                    plate: '', brand: '', year: '', tonnage: '', cycle: defaultCycle, lastDate: '', status: 'å®Œæˆ', 
                    insuranceDate: '', insurer: '', trailerType: '',
                    passName: '', passDate: '', passFile: '', passFileName: '', owner: '', notes: '',
                    specialStatus: 'ç„¡', specialDateStart: '', specialDateEnd: ''
                }); 
                setEditingId(null); 
            }
            setIsModalOpen(true);
        };

        const closeModal = () => setIsModalOpen(false);

        const sortedVehicles = useMemo(() => {
            const term = searchTerm.toUpperCase();
            return vehicles.filter(v => {
                const matchSearch = 
                    v.plate.includes(term) || 
                    (v.owner && v.owner.includes(term)) ||
                    (v.year && v.year.toString().includes(term)) ||
                    (v.tonnage && v.tonnage.toString().includes(term));

                const isSpecialTab = SPECIAL_STATUS_LIST.includes(activeTab);
                if (isSpecialTab) {
                    return v.specialStatus === activeTab && matchSearch;
                } else {
                    return v.company === activeTab && (v.specialStatus === 'ç„¡' || !v.specialStatus) && matchSearch;
                }
            }).sort((a, b) => {
                if (a.status === 'å¾…é©—' && b.status !== 'å¾…é©—') return -1;
                if (a.status !== 'å¾…é©—' && b.status === 'å¾…é©—') return 1;
                return a.plate.localeCompare(b.plate);
            });
        }, [vehicles, activeTab, searchTerm]);

        const ALL_TABS = [...COMPANY_LIST, ...SPECIAL_STATUS_LIST];

        return (
            <div className="flex flex-col h-full bg-slate-100 safe-area-top safe-area-bottom w-full max-w-full overflow-hidden">
                
                <input type="file" ref={fileInputRef} onChange={handleImport} accept=".json" style={{display:'none'}} />

                {showInstallGuide && (
                    <div className="fixed inset-0 z-50 bg-black/80 flex flex-col justify-end p-4 animate-fade-in">
                        <div className="bg-white rounded-xl p-6">
                            <h3 className="font-bold text-lg mb-4 text-blue-900">ğŸ“² è€é—†è«‹å®‰è£åˆ°æ¡Œé¢ (é‡è¦!)</h3>
                            <p className="mb-2">1. é»æ“Šä¸‹æ–¹ <span className="font-bold text-blue-600">åˆ†äº«æŒ‰éˆ•</span>ã€‚</p>
                            <p className="mb-4">2. é¸æ“‡ <span className="font-bold text-blue-600">åŠ å…¥ä¸»ç•«é¢</span>ã€‚</p>
                            <button onClick={() => setShowInstallGuide(false)} className="w-full bg-slate-200 py-3 rounded-lg font-bold">æˆ‘çŸ¥é“äº†</button>
                        </div>
                    </div>
                )}

                <div className="bg-blue-900 text-white p-3 shadow-lg z-10 w-full">
                    <div className="flex justify-between items-center mb-2">
                        <div className="flex items-center gap-1 shrink-0">
                            <span className="text-xl">ğŸš›</span>
                            <h1 className="font-bold text-lg">è»Šè¼›ç®¡ç†</h1>
                        </div>
                        <div className="flex gap-2 shrink-0">
                            <button onClick={() => exportSyncData(vehicles)} className="bg-purple-600 px-2 py-1.5 rounded text-xs font-bold shadow">å‚³é€</button>
                            <button onClick={() => fileInputRef.current.click()} className="bg-blue-500 px-2 py-1.5 rounded text-xs font-bold shadow">åŒ¯å…¥</button>
                            <button onClick={() => exportToExcel(vehicles)} className="bg-green-600 px-2 py-1.5 rounded text-xs font-bold shadow">å ±è¡¨</button>
                            <button onClick={() => openModal()} className="bg-yellow-500 text-blue-900 px-2 py-1.5 rounded font-bold shadow text-xs">â•</button>
                        </div>
                    </div>

                    {alerts.length > 0 && (
                        <div className="mb-2 bg-red-600 rounded p-1.5 flex items-center gap-2 text-xs text-white animate-pulse">
                            <span>âš ï¸</span><span className="font-bold">{alerts.length} å°éœ€è™•ç†</span>
                        </div>
                    )}

                    <div className="space-y-2 w-full">
                        <input type="text" placeholder="ğŸ” æœå°‹è»Šç‰Œã€è»Šä¸»ã€å¹´ä»½ã€å™¸æ•¸..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value.toUpperCase())}
                            className="w-full bg-blue-800/50 text-white placeholder-blue-300 rounded px-3 py-2 text-sm outline-none" />
                        <div className="flex overflow-x-auto gap-2 hide-scrollbar pb-1 w-full">
                            {ALL_TABS.map(tab => {
                                const isSpecial = SPECIAL_STATUS_LIST.includes(tab);
                                const count = vehicles.filter(v => {
                                    if (isSpecial) return v.specialStatus === tab;
                                    return v.company === tab && (v.specialStatus === 'ç„¡' || !v.specialStatus);
                                }).length;
                                return (
                                    <button key={tab} onClick={() => setActiveTab(tab)}
                                        className={`whitespace-nowrap px-3 py-1.5 rounded text-xs font-bold transition-colors flex-shrink-0 border ${
                                            activeTab === tab 
                                            ? 'bg-white text-blue-900 border-white' 
                                            : (isSpecial ? 'bg-gray-700 text-gray-200 border-gray-600' : 'bg-blue-800/40 text-blue-100 border-blue-800')
                                        }`}>
                                        {tab} <span className="ml-1 opacity-80">({count})</span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>

                <div className="flex-1 overflow-y-auto p-3 space-y-3 pb-20 w-full">
                    {sortedVehicles.length === 0 ? (
                        <div className="text-center py-10 text-slate-400">
                            <div className="text-4xl mb-2">ğŸš›</div>
                            <p>ç›®å‰ç„¡è»Šè¼›</p>
                            {COMPANY_LIST.includes(activeTab) && <p className="text-sm">é»å³ä¸Šè§’ã€Œâ•ã€æ–°å¢</p>}
                        </div>
                    ) : (
                        sortedVehicles.map(v => {
                            const limit = new Date(); limit.setDate(limit.getDate()+30);
                            const isInspExp = new Date(v.nextDate) <= limit;
                            const isInsExp = v.insuranceDate && new Date(v.insuranceDate) <= limit;
                            const isPassExp = v.passDate && new Date(v.passDate) <= limit;
                            const isCritical = v.status === 'å¾…é©—' || isInspExp || isInsExp || isPassExp;
                            const isInactive = v.specialStatus === 'å ±å»¢' || v.specialStatus === 'éæˆ¶' || v.specialStatus === 'åœé§›' || v.specialStatus === 'æ‰£ç‰Œ';
                            // åˆ¤æ–·æ˜¯å¦ç‚ºå°¾è»Š
                            const isTrailer = v.company && v.company.includes('(å°¾)');

                            return (
                                <div key={v.id} className={`bg-white rounded-lg shadow p-3 border-l-4 ${isInactive ? 'border-gray-400' : (isCritical ? (v.status==='å¾…é©—'?'border-red-500':'border-orange-400') : 'border-green-500')}`}>
                                    <div className="flex justify-between items-start mb-2 border-b pb-2">
                                        <div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-xl font-bold text-slate-800">{v.plate}</span>
                                                {v.status === 'å¾…é©—' && !isInactive && <span className="bg-red-100 text-red-600 text-[10px] px-1.5 py-0.5 rounded font-bold">å¾…é©—</span>}
                                                {v.specialStatus && v.specialStatus !== 'ç„¡' && <span className="text-[10px] px-1.5 py-0.5 rounded font-bold bg-gray-200 text-gray-600">{v.specialStatus}</span>}
                                            </div>
                                            <div className="text-xs text-slate-500 mt-1 flex flex-wrap gap-x-2">
                                                <span>{v.brand}</span><span className="text-slate-300">|</span>
                                                <span>{v.year}å¹´({v.cycle})</span><span className="text-slate-300">|</span>
                                                <span>{v.tonnage ? v.tonnage+'å™¸' : '-å™¸'}</span>
                                            </div>
                                            <div className="text-sm font-bold text-blue-800 mt-1">ğŸ‘¤ {v.owner || 'æœªå¡«è»Šä¸»'}</div>
                                            {SPECIAL_STATUS_LIST.includes(activeTab) && <div className="text-xs text-gray-400 mt-1">æ‰€å±¬: {v.company}</div>}
                                        </div>
                                        <div className="flex gap-3 text-lg">
                                            <button onClick={() => openModal(v)}>âœï¸</button>
                                            <button onClick={() => handleDelete(v.id)}>ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-2 text-sm mt-2">
                                        <div className="bg-slate-50 p-2 rounded border border-slate-100">
                                            <div className="text-[10px] text-slate-400 flex justify-between"><span>ä¸‹æ¬¡é©—è»Š</span><span className="text-[9px]">{toROCDate(v.lastDate)}</span></div>
                                            <div className={`font-bold text-base ${!isInactive && (v.status==='å¾…é©—'||isInspExp)?'text-red-600':''}`}>ğŸ“… {toROCDate(v.nextDate)}</div>
                                        </div>
                                        
                                        {isTrailer ? (
                                            <div className="bg-blue-50 p-2 rounded border border-blue-100">
                                                <div className="text-[10px] text-blue-700">è»Šå°¾å‹å¼</div>
                                                <div className="font-bold text-base text-blue-900">{v.trailerType || 'æœªå¡«å¯«'}</div>
                                            </div>
                                        ) : (
                                            <div className="bg-green-50 p-2 rounded border border-green-100 relative">
                                                <div className="text-[10px] text-green-700 flex justify-between items-center">
                                                    <span>ä¿éšªåˆ°æœŸ</span>
                                                    <span className="text-[9px]">{v.insurer}</span>
                                                </div>
                                                <div className="flex justify-between items-end mt-1">
                                                    <div className="font-bold text-base text-slate-700">ğŸ›¡ï¸ {toROCDate(v.insuranceDate) || '--'}</div>
                                                    <button onClick={() => handleRenewInsurance(v.id, v.insuranceDate)} className="bg-green-600 text-white text-[10px] px-2 py-1 rounded shadow hover:bg-green-700">å·²çºŒ</button>
                                                </div>
                                            </div>
                                        )}

                                        {(v.passName || v.passDate || v.passFile) && (
                                            <div className="col-span-2 bg-purple-50 p-2 rounded border border-purple-100 flex flex-col gap-1">
                                                <div className="flex justify-between items-center">
                                                    <div className="text-[10px] text-purple-700">ğŸ« {v.passName || 'é€šè¡Œè­‰'}</div>
                                                    <div className={`font-bold text-base ${!isInactive && isPassExp ? 'text-red-600' : 'text-purple-900'}`}>{toROCDate(v.passDate) || '--'}</div>
                                                </div>
                                                {v.passFile && <a href={v.passFile} download={v.passFileName || "é€šè¡Œè­‰"} className="text-xs text-center bg-white border border-purple-200 text-purple-700 py-1 rounded font-bold">ğŸ“„ ä¸‹è¼‰/æŸ¥çœ‹é€šè¡Œè­‰</a>}
                                            </div>
                                        )}
                                    </div>
                                    
                                    {v.specialStatus && v.specialStatus !== 'ç„¡' && (v.specialDateStart || v.specialDateEnd) && (
                                        <div className="mt-2 text-xs bg-gray-100 p-2 rounded text-gray-700 border border-gray-200"><strong>{v.specialStatus}æ—¥æœŸï¼š</strong> {toROCDate(v.specialDateStart)} ~ {toROCDate(v.specialDateEnd) || 'æœªå®š'}</div>
                                    )}
                                    {v.notes && <div className="mt-2 text-xs bg-yellow-50 p-2 rounded text-yellow-800 border border-yellow-100">ğŸ“ {v.notes}</div>}
                                    <div className="flex gap-2 mt-2">
                                        <button onClick={() => downloadCalendarEvent(v)} className="flex-1 border border-blue-200 text-blue-600 py-1.5 rounded text-xs font-bold bg-blue-50">ğŸ”” åŠ å…¥è¡Œäº‹æ›†</button>
                                    </div>
                                </div>
                            )
                        })
                    )}
                </div>

                {isModalOpen && (
                    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                        <div className="bg-white w-full max-w-md rounded-xl p-4 shadow-2xl max-h-[90vh] overflow-y-auto">
                            <div className="flex justify-between items-center mb-4 border-b pb-2">
                                <h3 className="font-bold text-lg">{editingId ? 'ç·¨è¼¯' : 'æ–°å¢'}</h3>
                                <button onClick={closeModal} className="text-xl">âœ–ï¸</button>
                            </div>
                            <form onSubmit={handleSave} className="space-y-3">
                                <div><label className="text-xs font-bold text-slate-500">æ‰€å±¬å…¬å¸</label>
                                    <select className="w-full border rounded p-2 bg-white" value={formData.company} 
                                        onChange={e => {
                                            const c = e.target.value;
                                            setFormData({
                                                ...formData, 
                                                company: c,
                                                cycle: calculateCycle(formData.year, c)
                                            });
                                        }}>
                                        {COMPANY_LIST.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs font-bold text-slate-500">è»Šè™Ÿ *</label><input required className="w-full border rounded p-2 uppercase font-bold" placeholder="ABC-1234" value={formData.plate} onChange={e=>setFormData({...formData, plate: e.target.value.toUpperCase()})} /></div>
                                    <div><label className="text-xs font-bold text-slate-500">å“ç‰Œ</label><input className="w-full border rounded p-2" value={formData.brand} onChange={e=>setFormData({...formData, brand: e.target.value})} /></div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">å¹´ä»½(è¥¿å…ƒ)*</label>
                                        <input required type="number" className="w-full border rounded p-2" value={formData.year} 
                                            onChange={e=>{
                                                const y=e.target.value;
                                                setFormData({
                                                    ...formData, 
                                                    year: y, 
                                                    cycle: calculateCycle(y, formData.company)
                                                });
                                            }} 
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">{formData.company.includes('(å°¾)') ? 'è»Šå°¾è¦æ ¼' : 'å™¸æ•¸'}</label>
                                        {formData.company.includes('(å°¾)') ? (
                                            <select className="w-full border rounded p-2 bg-white" value={formData.tonnage} onChange={e => setFormData({...formData, tonnage: e.target.value})}>
                                                <option value="">è«‹é¸æ“‡</option>
                                                <option value="è»Šå°¾(åŠ)">è»Šå°¾(åŠ)</option>
                                                <option value="è»Šå°¾(å…¨)">è»Šå°¾(å…¨)</option>
                                            </select>
                                        ) : (
                                            <input type="number" className="w-full border rounded p-2" value={formData.tonnage} onChange={e => setFormData({...formData, tonnage: e.target.value})} />
                                        )}
                                    </div>
                                </div>
                                <div><label className="text-xs font-bold text-slate-500">è»Šä¸»å§“å</label><input className="w-full border rounded p-2" placeholder="è¼¸å…¥è»Šä¸»å§“å" value={formData.owner} onChange={e=>setFormData({...formData, owner: e.target.value})} /></div>
                                
                                <div className="bg-slate-50 p-3 rounded border border-slate-200">
                                    <div className="grid grid-cols-2 gap-3 mb-2">
                                        <div><label className="text-xs font-bold text-slate-500">é©—è»Šæ—¥æœŸ *</label><input required type="date" className="w-full border rounded p-2 mt-1" value={formData.lastDate} onChange={e=>setFormData({...formData, lastDate: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-blue-600">{formData.cycle === 'åŠå¹´' ? 'åŠå¹´å¾Œé©—è»Š' : 'ä¸‹æ¬¡é©—è»Š'}</label><div className="w-full border rounded p-2 mt-1 bg-blue-50 text-blue-800 h-[38px] flex items-center">{formData.lastDate ? toROCDate(calculateNextDate(formData.lastDate, formData.cycle)) : 'è‡ªå‹•æ¨ç®—'}</div></div>
                                    </div>
                                    <div className="flex gap-2">
                                        {['å®Œæˆ', 'å¾…é©—'].map(s => (
                                            <button type="button" key={s} onClick={() => {
                                                if (s === 'å®Œæˆ') {
                                                    const nextDate = calculateNextDate(formData.lastDate, formData.cycle);
                                                    if (confirm(`æ›´æ–°ä¸‹æ¬¡é©—è»Šæ—¥ç‚ºï¼š\n${toROCDate(nextDate)}ï¼Ÿ`)) {
                                                        setFormData({ ...formData, status: s, lastDate: nextDate });
                                                    } else { setFormData({ ...formData, status: s }); }
                                                } else { setFormData({ ...formData, status: s }); }
                                            }} className={`flex-1 py-1.5 rounded text-xs font-bold ${formData.status === s ? (s === 'å®Œæˆ' ? 'bg-green-500 text-white' : 'bg-red-500 text-white') : 'bg-white border text-slate-500'}`}>{s}</button>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* --- æ ¸å¿ƒä¿®æ”¹ï¼šå‹•æ…‹é¡¯ç¤ºä¿éšªå€å¡Š æˆ– è»Šå°¾å‹å¼å€å¡Š --- */}
                                {formData.company.includes('(å°¾)') ? (
                                    <div className="bg-blue-50 p-3 rounded border border-blue-100">
                                        <label className="text-xs font-bold text-blue-800">è»Šå°¾å‹å¼</label>
                                        <input className="w-full border rounded p-2 mt-1" placeholder="ä¾‹å¦‚ï¼šå¹³æ¿å¼ã€å‡¹å‹å¹³æ¿å¼" value={formData.trailerType} onChange={e=>setFormData({...formData, trailerType: e.target.value})} />
                                    </div>
                                ) : (
                                    <div className="bg-green-50 p-3 rounded border border-green-100">
                                        <div className="space-y-3">
                                            <div><label className="text-xs font-bold text-green-800">ä¿éšªåˆ°æœŸ</label><input type="date" className="w-full border rounded p-2 mt-1" value={formData.insuranceDate} onChange={e=>setFormData({...formData, insuranceDate: e.target.value})} /></div>
                                            <div><label className="text-xs font-bold text-green-800">ä¿éšªå…¬å¸</label><input className="w-full border rounded p-2 mt-1" placeholder="ä¾‹å¦‚ï¼šå¯Œé‚¦" value={formData.insurer} onChange={e=>setFormData({...formData, insurer: e.target.value})} /></div>
                                        </div>
                                    </div>
                                )}

                                <div className="bg-purple-50 p-3 rounded border border-purple-100">
                                    <div className="space-y-3">
                                        <div><label className="text-xs font-bold text-purple-800">é€šè¡Œè­‰åˆ°æœŸ</label><input type="date" className="w-full border rounded p-2 mt-1" value={formData.passDate} onChange={e=>setFormData({...formData, passDate: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-purple-800">é€šè¡Œè­‰åç¨±</label><input className="w-full border rounded p-2 mt-1" placeholder="ä¾‹å¦‚ï¼šåŸºéš†æ¸¯" value={formData.passName} onChange={e=>setFormData({...formData, passName: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-purple-800 flex justify-between"><span>é€šè¡Œè­‰æª”æ¡ˆ</span>{formData.passFile && <span className="text-red-500" onClick={clearPassFile}>ğŸ—‘ï¸ åˆªé™¤</span>}</label><input type="file" accept="application/pdf, image/*" className="w-full text-xs mt-1" ref={passFileInputRef} onChange={handlePassFileChange} />{formData.passFileName && <div className="text-[10px] text-gray-500 mt-1">å·²é¸: {formData.passFileName}</div>}</div>
                                    </div>
                                </div>

                                <div className="bg-gray-100 p-3 rounded border border-gray-200">
                                    <div className="space-y-3">
                                        <div className="flex items-end gap-2">
                                            <div className="flex-1"><label className="text-xs font-bold text-gray-700">ç‹€æ…‹è®Šæ›´</label><select className="w-full border rounded p-2 mt-1 bg-white font-bold text-blue-900" value={formData.specialStatus} onChange={e => setFormData({...formData, specialStatus: e.target.value})}>{SPECIAL_STATUS_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select></div>
                                            {formData.specialStatus !== 'ç„¡' && (
                                                <button type="button" onClick={() => {if(confirm('ç¢ºå®šæ¢å¾©æ­£å¸¸ç‹€æ…‹ï¼Ÿ')) {setFormData({ ...formData, specialStatus: 'ç„¡', specialDateStart: '', specialDateEnd: '' });}}} className="bg-green-600 text-white px-3 py-2 rounded-lg font-bold text-xs shadow-md whitespace-nowrap mb-[1px]">ğŸ”„ æ¢å¾©æ­£å¸¸</button>
                                            )}
                                        </div>
                                        {formData.specialStatus !== 'ç„¡' && (
                                            <div className="grid grid-cols-2 gap-3">
                                                <div><label className="text-xs font-bold text-gray-600">é–‹å§‹æ—¥æœŸ</label><input type="date" className="w-full border rounded p-2 mt-1" value={formData.specialDateStart} onChange={e=>setFormData({...formData, specialDateStart: e.target.value})} /></div>
                                                <div><label className="text-xs font-bold text-gray-600">çµæŸæ—¥æœŸ</label><input type="date" className="w-full border rounded p-2 mt-1" value={formData.specialDateEnd} onChange={e=>setFormData({...formData, specialDateEnd: e.target.value})} /></div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                <div><label className="text-xs font-bold text-slate-500">å‚™è¨»</label><textarea className="w-full border rounded p-2" rows="2" value={formData.notes} onChange={e=>setFormData({...formData, notes: e.target.value})}></textarea></div>
                                <button className="w-full bg-blue-900 text-white py-3 rounded-lg font-bold text-lg shadow-md">å„²å­˜è³‡æ–™</button>
                            </form>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
